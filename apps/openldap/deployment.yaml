---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: openldap-secrets
  namespace: openldap
spec:
  encryptedData:
    LDAP_ADMIN_PASSWORD: AgA54RdBNr7l2eJOC2DdO+TZgveOdgxmEJCX+XZJ1x5wkqVdbwYBLApQSm8InzqSU1uPfyfSHc8sXMnelmCsigSCBdph2NuE4thZyyD9DzYtbZWI0/mca2FaUxr/3l6b9cYlMJqjJL+bXkpe2/hWmKVBrwsXK8jVFdJ1Ct1as7ccqPpuWjS21dpERFvmbiaCNQiqG75NkJdLCsivLWdMWiRAlNS//7f9x47kMx9S0vtQGBI0GbdvhuqnKpqKTsZtpVcD0J9TZSU3zC+Zm+jwVWXBIP6bim96DhTCS2YxHNpiqUW7OvBYOYUXVAja/J199B/7JfpGN1kyynWr0jqZHQJs5yEffxjbeULGAT2CwrVXmWWFjHX8cuffBWz9jFi+gcMKLMnqJBkJBEqjrE0Qjl/cVBUJWZBG2zh9R0sVcDMZFS5rWc0TFkEtDNcZ0U9IoaKOGsGPcqf1/EzW5P23cv4a9WJnBpw03KdDPzuQqzFYSnHJRt4fJTyTOie3aEB/+Jhz1BK7SSwocSakeKBup7fm/sbEn8fuNvdZlHi5Tmon/8ZtJV6tEimjwX+7OQ0MPqOldEoqKVieHqCs/kXLKkj5xDiCzItuV6v9LCh75qRkzAcGKJQHK8bp11BEQUDE5Y64cmtMr1+7Dt2+WCaS/FSYkzBR9CAwUFJ1+7gzTpGhDLcMOWUNEpC7S0JpgPXwURPgPP/RyNElLg==
    LDAP_CONFIG_PASSWORD: AgBtluQL02WhYIH87LgwcRkqLv/PfNNXyc48DaISsl8o1CERh5vuPSDxxmTStJPVapTBznhJrWtRAQGjyQs7BHpBLW34iB4fSWc8R/lRZU5GG4p/nRcIk0N+dNIZkOAlvTn3+mOJA34o8sfS6Zk3SAkfQUkc42rZHYsIsAC3Y/JAeOU6u8G5j22+CVWR04BFReAKVkhkXb4HwWDcwZP5YrhflaLAvhccU0G/3nOCA9aWFX+OJ0xCDUA9cTCqof0rjDiqT8AQ9qO5QOXvHyz03GReQDxh4NaEjuAp7iQdu9tLTrOLUutqLNvNj2HBKsuaYLmufM0bqmyZwasbjlPiQg2oYbBd9vX25Y2scqM/V8SPmErIBEKIR98Z+CY3U04grWCb8/6rgF2um5g4AiPC+eS0tDi3VxQYtlynE81d791PJQXnhEp4mASrdxM4eSsxgFj4DJhmIwOVQO44c261TMacLyXhZHed3UPd33jleBHqR4NfDIEHXBy7Yhu3d+WU16cT1Cmj8t4tu0XHjhShDwQL0kTDNi5enKQ5t9uafIrHDjrtxJgqL+AiKSpvDr/ddfCT7AgzP2yI47jiuv5qQp+Ia6R1k7P/k5dOX1ITndPQz/uG+5Uzarq7cL/SMvXe2Qta8j0AsJ7b+anzVpJ49oCSLZt0rQaHbiBDcDoC68KyAhoJo8QYMn5SWA4favpKHBBspeILc8jXNw==
    LDAP_READONLY_USER_PASSWORD: AgBUXDLzzd/4NRFmOfYtz9LFJ8ikyIqEtR14R9138iVjSe2DFxEUzzyjVPDh/TJgbcmwH9aUO6NFYEGCW2Zzd3qUKVlDOH5Hinm3ug+Fb3iOrCJspr36LDJICB3/+P9kR8uwNwyg5EEvVXUJ/tqTSqEzwEXe8wPq1uC3dEF6ufISWhUufXgiBEDCKDZMNydcKpGhlBJm645JUMz4yYef5c4/SesZRWuam9FYSHbG2UFEh1VB21lBNCT6ohaEem5XdpVTNd0CSfnp/Qe7qp+ekRHPJ4nDiNHTTCxwQAAPN6+90sS3YRyIHKCMDGKjsBTgyZ6BeUnyHeSjYHBWOTPRKZUEG42wZbQi896D1S0LsOunquoqVPLpZ2w4164GxT6WQ7XKn6Ujz3pleUc9g+ro1BcsQX0a1muCziWzotM+CyeMAI2mPscV7/ZDZ0lkQJteBm7wgqIZxb/LjSwaYbLya5G2nYGyvIL8hU7tbMulJ8ny/+CphX3s76nNg6JCPxFCBoZBQLuifx3KhxdEt9WioNLoQOhDMhepxuVn4aQsAXW+4Pyo9rvzvXezWCyRDC3USbnmE4x6SFkb3yxxVdZzbOKe4OPTAIGjNrKpJa+741z5XcA/Yh7d7EHlkoeDHhYq2fQFAhlZqPFH1eIYkWesgcBmsQgo9mbZOwLaI3KmlWLqrSwi8lNJzsmAbi0odC7sgCGLD157EwUN4g==
  template:
    metadata:
      creationTimestamp: null
      name: openldap-secrets
      namespace: openldap
    type: Opaque

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openldap-env
  namespace: openldap
data:
  LDAP_ORGANISATION: "HZarkov Space"
  LDAP_DOMAIN: "hzarkov.bg"
  LDAP_BASE_DN: "dc=hzarkov,dc=bg"
  LDAP_READONLY_USER: "false"
  LDAP_RFC2307BIS_SCHEMA: "false"
  LDAP_BACKEND: "mdb"
  LDAP_TLS: "true"
  LDAP_TLS_CRT_FILENAME: "ldap.crt"
  LDAP_TLS_KEY_FILENAME: "ldap.key"
  LDAP_TLS_DH_PARAM_FILENAME: "dhparam.pem"
  LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
  LDAP_TLS_ENFORCE: "false"
  LDAP_TLS_CIPHER_SUITE: "SECURE256:+SECURE128:-VERS-TLS-ALL:+VERS-TLS1.2:-RSA:-DHE-DSS:-CAMELLIA-128-CBC:-CAMELLIA-256-CBC"
  LDAP_TLS_VERIFY_CLIENT: "never"
  LDAP_REPLICATION: "false"
  KEEP_EXISTING_CONFIG: "false"
  LDAP_REMOVE_CONFIG_AFTER_SETUP: "true"
  LDAP_SSL_HELPER_PREFIX: "ldap"

---
apiVersion: v1
kind: Service
metadata:
  name: openldap
  namespace: openldap
  labels:
    app: openldap
spec:
  type: ClusterIP
  ports:
    - name: ldap
      port: 389
      targetPort: 389
      protocol: TCP
    - name: ldaps
      port: 636
      targetPort: 636
      protocol: TCP
  selector:
    app: openldap
  clusterIP: None  # Headless service for StatefulSet

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openldap
  namespace: openldap
  labels:
    app: openldap
spec:
  serviceName: openldap
  replicas: 1
  selector:
    matchLabels:
      app: openldap
  template:
    metadata:
      labels:
        app: openldap
    spec:
      containers:
      - name: openldap
        image: osixia/openldap:1.5.0
        imagePullPolicy: IfNotPresent
        envFrom:
        - configMapRef:
            name: openldap-env
        - secretRef:
            name: openldap-secrets
        ports:
        - name: ldap
          containerPort: 389
          protocol: TCP
        - name: ldaps
          containerPort: 636
          protocol: TCP
        volumeMounts:
        - name: data
          mountPath: /var/lib/ldap
        - name: config
          mountPath: /etc/ldap/slapd.d
        livenessProbe:
          tcpSocket:
            port: ldap
          initialDelaySeconds: 20
          periodSeconds: 10
          failureThreshold: 10
        readinessProbe:
          tcpSocket:
            port: ldap
          initialDelaySeconds: 20
          periodSeconds: 10
          failureThreshold: 10
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: local-path  # k3s default storage class
      resources:
        requests:
          storage: 1Gi
  - metadata:
      name: config
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: local-path
      resources:
        requests:
          storage: 256Mi
